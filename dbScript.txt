-- 1. Xóa cơ sở dữ liệu nếu tồn tại và tạo lại
DROP DATABASE IF EXISTS test;
CREATE DATABASE test;
USE test;

-- 2. Tạo các bảng không có khóa ngoại
CREATE TABLE role(
                     id INT PRIMARY KEY AUTO_INCREMENT,
                     name VARCHAR(255) NOT NULL,
                     description VARCHAR(255) DEFAULT NULL
);

CREATE TABLE tag(
                    id INT PRIMARY KEY AUTO_INCREMENT,
                    name VARCHAR(255) NOT NULL,
                    description VARCHAR(255) NOT NULL
);

CREATE TABLE type(
                     id INT PRIMARY KEY AUTO_INCREMENT,
                     name VARCHAR(255) NOT NULL,
                     description VARCHAR(255) NOT NULL
);

-- 3. Tạo bảng user (tham chiếu role)
CREATE TABLE user(
                     id INT PRIMARY KEY AUTO_INCREMENT,
                     username VARCHAR(255) NOT NULL,
                     password VARCHAR(255) NOT NULL,
                     email VARCHAR(255) NOT NULL,
                     role_id INT NOT NULL,
                     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                     avatar MEDIUMBLOB NULL,
                     feature_face MEDIUMBLOB NULL,
                     FOREIGN KEY(role_id) REFERENCES role(id)
);

-- 4. Tạo bảng quiz (tham chiếu user và type)
CREATE TABLE quiz(
                     id INT PRIMARY KEY AUTO_INCREMENT,
                     name VARCHAR(255) NOT NULL,
                     description VARCHAR(255) NOT NULL,
                     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                     updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                     user_id INT NOT NULL,
                     type_id INT NOT NULL,
                     answer JSON NOT NULL,
                     FOREIGN KEY (user_id) REFERENCES user(id),
                     FOREIGN KEY (type_id) REFERENCES type(id)
);

-- 5. Tạo bảng user_quiz (tham chiếu user, quiz, tag)
CREATE TABLE user_quiz(
                          user_id INT NOT NULL,
                          quiz_id INT NOT NULL,
                          tag_id INT NOT NULL,
                          FOREIGN KEY (user_id) REFERENCES user(id),
                          FOREIGN KEY (quiz_id) REFERENCES quiz(id),
                          FOREIGN KEY (tag_id) REFERENCES tag(id)
);

-- 6. Tạo bảng class (tham chiếu user)
CREATE TABLE class(
                      id INT PRIMARY KEY AUTO_INCREMENT,
                      name VARCHAR(255) NOT NULL,
                      class_key VARCHAR(255) NOT NULL,
                      description VARCHAR(255) NOT NULL,
                      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                      teacher_id INT NOT NULL,
                      FOREIGN KEY (teacher_id) REFERENCES user(id)
);

-- 7. Tạo bảng class_user (tham chiếu class và user)
CREATE TABLE class_user(
                           class_id INT NOT NULL,
                           user_id INT NOT NULL,
                           FOREIGN KEY (class_id) REFERENCES class(id),
                           FOREIGN KEY (user_id) REFERENCES user(id)
);

-- 8. Tạo bảng class_quiz (tham chiếu class và quiz)
CREATE TABLE class_quiz(
                           class_id INT NOT NULL,
                           quiz_id INT NOT NULL,
                           FOREIGN KEY (class_id) REFERENCES class(id),
                           FOREIGN KEY (quiz_id) REFERENCES quiz(id)
);

-- 9. Tạo bảng result (tham chiếu user, quiz, class)
CREATE TABLE result(
                       id INT PRIMARY KEY AUTO_INCREMENT,
                       user_id INT NOT NULL,
                       quiz_id INT NOT NULL,
                       class_id INT NOT NULL,
                       score FLOAT NOT NULL,
                       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                       FOREIGN KEY (user_id) REFERENCES user(id),
                       FOREIGN KEY (quiz_id) REFERENCES quiz(id),
                       FOREIGN KEY (class_id) REFERENCES class(id)
);

-- 10. Chèn dữ liệu mẫu

-- 1. Roles
INSERT INTO role (name, description) VALUES
                                         ('teacher', 'User with permissions to create and manage classes and quizzes'),
                                         ('student', 'User with permissions to participate in classes and take quizzes');

-- 2. Users
INSERT INTO user (username, password, mail, role_id, avatar, feature_face) VALUES
                                                                               ('alice_teacher', 'hashed_password1', 'alice.teacher@example.com', 1, NULL, NULL),
                                                                               ('bob_student', 'hashed_password2', 'bob.student@example.com', 2, NULL, NULL),
                                                                               ('carol_student', 'hashed_password3', 'carol.student@example.com', 2, NULL, NULL);

-- 3. Types
INSERT INTO type (name, description) VALUES
                                         ('Multiple Choice', 'Quizzes with multiple choice questions'),
                                         ('True/False', 'Quizzes with true or false questions'),
                                         ('Short Answer', 'Quizzes requiring short text answers');

-- 4. Tags
INSERT INTO tag (name, description) VALUES
                                        ('Mathematics', 'Quizzes related to math topics'),
                                        ('Science', 'Quizzes related to science topics'),
                                        ('History', 'Quizzes related to historical events');

-- 5. Quizzes
INSERT INTO quiz (name, description, user_id, type_id, answer) VALUES
                                                                   ('Algebra Basics', 'A quiz on fundamental algebra concepts', 1, 1,
                                                                    JSON_ARRAY(
                                                                            JSON_OBJECT('question', 'What is 2+2?', 'options', JSON_ARRAY('3','4','5','6'), 'correct', '4'),
                                                                            JSON_OBJECT('question', 'Solve for x: x + 5 = 10.', 'options', JSON_ARRAY('3','5','10','15'), 'correct', '5')
                                                                    )
                                                                   ),
                                                                   ('Basic Science', 'A quiz covering basic science principles', 1, 2,
                                                                    JSON_ARRAY(
                                                                            JSON_OBJECT('question', 'The earth is flat.', 'correct', false),
                                                                            JSON_OBJECT('question', 'Water boils at 100°C.', 'correct', true)
                                                                    )
                                                                   );

-- 6. Classes
INSERT INTO class (name, class_key, description, teacher_id) VALUES
                                                                 ('Math 101', 'MATH101', 'Introduction to Mathematics', 1),
                                                                 ('Science 101', 'SCI101', 'Introduction to Science', 1);

-- 7. Class Users
-- Enroll in Math 101
INSERT INTO class_user (class_id, user_id) VALUES
                                               (1, 2),
                                               (1, 3);

-- Enroll in Science 101
INSERT INTO class_user (class_id, user_id) VALUES
                                               (2, 2),
                                               (2, 3);

-- 8. Class Quizzes
INSERT INTO class_quiz (class_id, quiz_id) VALUES
                                               (1, 1), -- Algebra Basics assigned to Math 101
                                               (2, 2); -- Basic Science assigned to Science 101

-- 9. User Quizzes
INSERT INTO user_quiz (user_id, quiz_id, tag_id) VALUES
                                                     (1, 1, 1), -- Alice created Algebra Basics tagged Mathematics
                                                     (1, 2, 2); -- Alice created Basic Science tagged Science

-- 10. Results
-- Bob's results
INSERT INTO result (user_id, quiz_id, class_id, score) VALUES
                                                           (2, 1, 1, 85.5), -- Bob scored 85.5 in Algebra Basics
                                                           (2, 2, 2, 90.0); -- Bob scored 90.0 in Basic Science

-- Carol's results
INSERT INTO result (user_id, quiz_id, class_id, score) VALUES
                                                           (3, 1, 1, 78.0), -- Carol scored 78.0 in Algebra Basics
                                                           (3, 2, 2, 88.5); -- Carol scored 88.5 in Basic Science
